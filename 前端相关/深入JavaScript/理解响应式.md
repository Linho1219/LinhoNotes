# æ·±å…¥ç†è§£ Vue çš„å“åº”å¼ç³»ç»Ÿ

## ä½•ä¸ºå“åº”å¼

å¤§éƒ¨åˆ†äººå¯¹ã€Œå“åº”å¼ã€è®¾è®¡çš„åˆä½“éªŒæ˜¯ Excel â€”â€” åœ¨è¡¨æ ¼å†…è¾“å…¥å…¬å¼ï¼Œå½“å…¬å¼ä¾èµ–çš„å•å…ƒæ ¼çš„å€¼å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œå…¬å¼äº§ç”Ÿçš„å€¼ä¹Ÿä¼šå®æ—¶æ›´æ–°ã€‚åæ˜ åˆ°å‰ç«¯ä¸­ï¼Œå“åº”å¼ä¸€èˆ¬æŒ‡ï¼š

- æ•°æ®çš„æ›´æ–°ä¼šå®æ—¶åæ˜ åˆ°ç”¨æˆ·ç•Œé¢ï¼ˆå³ DOMï¼‰ä¸Šï¼Œå¯¹åº”ç€ Vue ä¸­çš„æ¨¡æ¿è¯­æ³•
- æ•°æ®çš„æ›´æ–°ä¼šä½¿å¾—ä¾èµ–å®ƒçš„æ•°æ®è·Ÿç€æ›´æ–°ï¼Œå¯¹åº”ç€ Vue ä¸­çš„ `computed` è®¡ç®—å±æ€§
- æ•°æ®çš„æ›´æ–°ä¼šè§¦å‘ä¸€äº›ä¾èµ–å®ƒçš„é€»è¾‘ï¼Œå¯¹åº”ç€ Vue ä¸­çš„ `watch`ã€`watchEffect` ç›‘å¬å™¨

è¿™ä¸‰ä»¶äº‹çš„æ ¸å¿ƒéƒ½æ˜¯**æ•°æ®çš„å˜åŠ¨**â€”â€”æ•°æ®çš„å˜åŠ¨ä¼šä½¿å¾—ä¾èµ–å®ƒçš„å†…å®¹ä¸€èµ·å˜åŠ¨ã€‚å†è¿›ä¸€æ­¥ï¼Œè¿™ä¸‰ä»¶äº‹å…¶å®æ˜¯ä¸€ä»¶äº‹ï¼š**æ•°æ®ç»‘å®šäº†é€»è¾‘ï¼ˆå‡½æ•°ï¼‰ã€‚**

- æ¨¡æ¿çš„æœ¬è´¨æ˜¯ VNodeï¼Œæ•°æ®çš„æ›´æ–°å¯¼è‡´ç”Ÿæˆ VNode çš„å‡½æ•°é‡æ–°è°ƒç”¨
- æ•°æ®çš„æ›´æ–°å¯¼è‡´ `computed` å‡½æ•°é‡æ–°è°ƒç”¨ï¼Œäº§ç”Ÿäº†æ–°çš„å€¼
- æ•°æ®æ›´æ–°è§¦å‘çš„é€»è¾‘ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯å‡½æ•°

> [!note]
>
> æœ‰å…³ Vue.js VNode çš„æ›´å¤šå†…å®¹ï¼Œå¯å‚é˜…å®˜æ–¹æ–‡æ¡£ï¼š[æ¸²æŸ“æœºåˆ¶](https://cn.vuejs.org/guide/extras/rendering-mechanism.html)ã€[æ¸²æŸ“å‡½æ•°ä¸ JSX](https://cn.vuejs.org/guide/extras/render-function.html)ã€‚

## ç›‘å¬æ•°æ®çš„å˜åŠ¨

å¦‚ä½•ç›‘å¬æ•°æ®çš„å˜åŠ¨ï¼Ÿé¦–å…ˆè¦æ˜ç¡®ä¸€ä¸ªç‚¹ï¼š**JS æ²¡æœ‰æä¾›ä»»ä½•æ–¹å¼è¿½è¸ªå˜é‡çš„è¯»å–å’Œå†™å…¥ï¼Œä½†æ˜¯ JS å¯ä»¥è¿½è¸ªå¯¹è±¡å±æ€§çš„è¯»å–å’Œå†™å…¥**ã€‚

æ‰€ä»¥æœ‰ä¸¤ç§åŠæ³•ï¼š

1. æŠŠä¸€ä¸ªå€¼åŒ…è£…æˆå¯¹è±¡ï¼Œé€šè¿‡ `obj.value` è¯»å–å’Œå†™å…¥å€¼
2. å¹²è„†å°†å€¼éƒ½å†™åœ¨å¯¹è±¡å±æ€§ä¸­ï¼Œç›´æ¥ç›‘æ§è¿™ä¸ªå¯¹è±¡

è¿™ä¸¤ç§æ–¹å¼åˆ†åˆ«å¯¹åº”äº† Vue çš„ `ref` å’Œ `reactive` APIã€‚

å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ª `value` å±æ€§éœ€è¦ç›‘å¬ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ [`Object.defineProperty` æ–¹æ³•](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty) æ¥å®šä¹‰æŸä¸ªå±æ€§çš„ getter å’Œ setterï¼š

```ts
type Ref<T> = {
  value: T;
};

function ref<T>(initial: T): Ref<T> {
  const refObj = <Ref<T>>{};
  return Object.defineProperty(refObj, "value", {
    get: () => {
      console.log("get:", initial);
      return initial;
    },
    set: (v) => {
      console.log("set:", v);
      initial = v;
      return v;
    },
  });
}

const a = ref(1);
console.log(a.value);
// get: 1
// 1
a.value = 2;
// set: 2
console.log(a.value);
// get: 2
// 2
```

å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œç›‘å¬æ•´ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå¯ä»¥ç”¨ [Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy) å®ç°ï¼š

```ts
type Reactive<T extends object> = T;

function reactive<T extends object>(obj: T): Reactive<T> {
  const reactiveObj = new Proxy(obj, {
    get(target: T, key: string) {
      console.log("get:", key);
      return key in target ? target[key] : undefined;
    },
    set(target: T, key: string, value: any) {
      console.log("set:", key, value);
      target[key] = value;
      return value;
    },
  });
  return reactiveObj;
}

const rObj = reactive({ foo: "foo!", bar: 2 });
console.log(rObj.foo);
// get: foo
// foo!
rObj.bar++;
// get: bar
// set: bar 3
```

é‚£ä¹ˆç›®å‰æˆ‘ä»¬åªæ˜¯å®ç°äº† `ref` å’Œ `reactive` ä¸¤ä¸ªå­˜æ”¾æ•°æ®çš„å®¹å™¨ï¼Œè¿˜æ²¡æœ‰åœ¨è¯»å†™å±æ€§æ—¶æ‰§è¡Œä»€ä¹ˆé€»è¾‘ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¸€å¼ è¡¨æ¥ä¿å­˜æ¯ä¸ªå“åº”å¼æ•°æ®æ‰€å¯¹åº”çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éœ€è¦åœ¨å“åº”å¼æ•°æ®ä¿®æ”¹æ—¶æ‰§è¡Œï¼ˆç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°±ä¸è€ƒè™‘è¿™äº›å‡½æ•°çš„ä¼ å‚é—®é¢˜äº†ï¼‰ã€‚å»ºç«‹ä¸€ä¸ª WeakMap `effectMap` æ¥å­˜å‚¨ï¼š

```ts {1-2}
// [!code escape-format]
type Dependency = Ref<any> | Reactive<object>;
const effectMap = new WeakMap<Dependency, Set<Function>>();

function ref<T>(initial: T): Ref<T> {
  const refObj = <Ref<T>>{};
  return Object.defineProperty(refObj, "value", {
    // ...
    set: (v) => {
      // ...
      if (effectMap.has(refObj))
        // [!code ++]
        effectMap.get(refObj)!.forEach((fn) => fn()); // [!code ++]
      return v;
    },
  });
}

function reactive<T extends object>(obj: T): Reactive<T> {
  const reactiveObj = new Proxy(obj, {
    // ...
    set(target: T, key: string, value: any) {
      // ...
      if (effectMap.has(reactiveObj))
        // [!code ++]
        effectMap.get(reactiveObj)!.forEach((fn) => fn()); // [!code ++]
      return value;
    },
  });
  return reactiveObj;
}
```

::: details ä¸ºä»€ä¹ˆä½¿ç”¨ WeakMapï¼Ÿ

ç›¸æ¯”äºä½¿ç”¨ Mapï¼ŒWeakMap ä¿å­˜çš„æ˜¯é”®çš„å¼±å¼•ç”¨ï¼Œå› æ­¤ä¸ä¼šå¹²æ‰°åˆ° JS çš„åƒåœ¾å¤„ç†æœºåˆ¶ â€”â€” å½“ `ref` æˆ– `reactive` å¯¹è±¡çš„ä½œç”¨åŸŸè¢«å›æ”¶æ—¶ï¼ŒWeakMap ä¸ä¼šå½±å“å®ƒä»¬è¢«å›æ”¶ã€‚

WeakMap æ˜¯ä¸å¯éå†çš„ï¼Œç”¨ `console.log` ä¹Ÿæ‰“å°ä¸å‡ºå†…å®¹ã€‚ä½†æ˜¯åœ¨æµè§ˆå™¨çš„è°ƒè¯•æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°å†…å®¹ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯ JSï¼Œä½ å¯ä»¥å°†å…¶å¤åˆ¶åˆ°æ§åˆ¶å°ä¸­è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚

```js
const someNormalMap = new Map();
const someWeakMap = new WeakMap();
const foo = { value: 1 };
someNormalMap.set(foo, 1);
someWeakMap.set(foo, 1);
(() => {
  const bar1 = { value: 2 };
  const bar2 = { value: 2 };
  someNormalMap.set(bar1, 2);
  someWeakMap.set(bar2, 2);
})();
```

ç„¶åä½ å¯ä»¥åœ¨æ§åˆ¶å°ä¸­åˆ†åˆ«è¾“å…¥ `someNormalMap` å’Œ `someWeakMap` æ¥æŸ¥çœ‹å†…å®¹ï¼š

```ansi
[90m|>[39m someNormalMap
[90m<|[39m [90mâ–¼[39m Map(2) { {â€¦} => [35m1[39m, {â€¦} => [35m2[39m }
     [90mâ–¼[39m [2m[[Entries]][0m
       [90mâ–¶[39m [94m0[39m: {Object => 1}
       [90mâ–¶[39m [94m1[39m: {Object => 2}
       [2m[94msize[39m[0m: [35m2[39m
     [90mâ–¶[39m [2m[[Prototype]][0m: Map
[90mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[90m|>[39m someWeakMap
[90m<|[39m [90mâ–¼[39m WeakMap(2) { {â€¦} => [35m1[39m }
     [90mâ–¼[39m [2m[[Entries]][0m
       [90mâ–¶[39m [94m0[39m: {Object => 1}
       [2m[94msize[39m[0m: [35m1[39m
     [90mâ–¶[39m [2m[[Prototype]][0m: WeakMap
```

å¯ä»¥çœ‹åˆ°ï¼Œ`bar2` å·²ç»è¢«å›æ”¶ï¼Œ`someWeakMap` ä¸­åªå‰©ä¸‹äº†ä¸€æ¡è®°å½•ã€‚è€Œ `someNormalMap` é˜»æ­¢äº† `bar1` çš„å›æ”¶ï¼Œå°½ç®¡ `bar1` æ‰€åœ¨çš„å‡½æ•°ä½œç”¨åŸŸå·²ç»ç»“æŸã€‚

æœ‰å…³ä½œç”¨åŸŸçš„æ›´å¤šå†…å®¹ï¼Œå¯å‚é˜… [ä½œç”¨åŸŸã€é—­åŒ…ä¸éšå¼å—](./ä½œç”¨åŸŸä¸é—­åŒ…)ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap) ä¸Šé˜…è¯»ä¸ WeakMap æœ‰å…³çš„æ›´å¤šå†…å®¹ã€‚

:::

## å“åº”å¼ API çš„å®ç°

æœ‰äº†ä¸Šé¢è¿™äº›ï¼Œå®ç°å“åº”å¼ API å°±æ¯”è¾ƒå®¹æ˜“äº† â€”â€” åªè¦æŒ‰éœ€å°†å‡½æ•°åŠ å…¥åˆ° `effectMap` å³å¯ã€‚

### `watch`

æœ€ç®€å•çš„å°±æ˜¯ `watch`ï¼š

```ts
function watch(dep: Dependency | Dependency[], fn: () => void) {
  const depArr = dep instanceof Array ? dep : [dep];
  depArr.forEach((d) => {
    if (!effectMap.has(d)) effectMap.set(d, new Set());
    effectMap.get(d)!.add(fn);
  });
}
```

### `watchEffect`

`watchEffect` ä¼šå¤æ‚ä¸€äº›ï¼Œå› ä¸ºè¦ç›‘å¬å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­å“ªäº›å“åº”å¼æ•°æ®è¢«**è¯»å–**äº†ã€‚æˆ‘ä»¬å¯ä»¥å‡†å¤‡ä¸€ä¸ª flagï¼Œå½“éœ€è¦ã€Œå½•åˆ¶ã€æ•°æ®è¯»å–æƒ…å†µæ—¶å°† flag è®¾ä¸º trueï¼Œè®© getter ä»¬å»è®°å½•è¯»å–æƒ…å†µï¼š

```ts {7-9}
const recording = {
  isRecording: false,
  refSet: new Set<Dependency>(),
};

function watchEffect(fn: () => void) {
  recording.isRecording = true; // å¯åŠ¨ã€Œå½•åˆ¶ã€
  fn();
  recording.isRecording = false; // åœæ­¢ã€Œå½•åˆ¶ã€
  recording.refSet.forEach((ref) => {
    if (!effectMap.has(ref)) effectMap.set(ref, new Set());
    effectMap.get(ref)!.add(fn);
  });
  recording.refSet.clear();
}
```

å¹¶ä¿®æ”¹åˆšåˆšçš„ `ref` å’Œ `reactive`ï¼š

```ts
function ref<T>(initial: T): Ref<T> {
  const refObj = <Ref<T>>{};
  return Object.defineProperty(refObj, "value", {
    get: () => {
      console.log("get:", initial);
      if (recording.isRecording) recording.refSet.add(refObj); // [!code ++]
      return initial;
    },
    // ...
  });
}

function reactive<T extends object>(obj: T): Reactive<T> {
  const reactiveObj = new Proxy(obj, {
    get(target: T, key: string) {
      console.log("get:", key);
      if (recording.isRecording) recording.refSet.add(reactiveObj); // [!code ++]
      return key in target ? target[key] : undefined;
    },
    // ...
  });
  return reactiveObj;
}
```

### `computed`

`computed` API å¯ä»¥åŸºäºåˆšåˆšçš„ `watchEffect`ï¼š

```ts
function computed<T>(fn: () => T) {
  const refObj = ref(<T>null);
  watchEffect(() => (refObj.value = fn()));
  return refObj;
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªã€ŒçŒ´ç‰ˆã€Vue å“åº”å¼ APIã€‚å½“ç„¶ï¼Œå…·ä½“å®ç°å’Œ Vue æºç è‚¯å®šè¿˜æ˜¯æœ‰åŒºåˆ«ï¼Œå¾ˆå¤šè¾¹ç•Œæƒ…å†µä¹Ÿæ²¡æœ‰è€ƒè™‘ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªç”¨æ¥ç†è§£å“åº”å¼å®ç°åŸç†çš„ç¤ºä¾‹ï¼Œåº”è¯¥è¿˜æ˜¯è¶³å¤Ÿçš„ã€‚

::: details å®Œæ•´çš„ç¤ºä¾‹ä»£ç 

```ts
type Ref<T> = {
  value: T;
};
type Reactive<T extends object> = T;
type Dependency = Ref<any> | Reactive<object>;

const recording = {
  isRecording: false,
  refSet: new Set<Dependency>(),
};

const effectMap = new WeakMap<Dependency, Set<Function>>();

function ref<T>(initial: T): Ref<T> {
  const refObj = <Ref<T>>{};
  return Object.defineProperty(refObj, "value", {
    get: () => {
      console.log("get:", initial);
      if (recording.isRecording) recording.refSet.add(refObj);
      return initial;
    },
    set: (v) => {
      console.log("set:", v);
      initial = v;
      if (effectMap.has(refObj)) effectMap.get(refObj)!.forEach((fn) => fn());
      return v;
    },
  });
}

function reactive<T extends object>(obj: T): Reactive<T> {
  const reactiveObj = new Proxy(obj, {
    get(target: T, key: string) {
      console.log("get:", key);
      if (recording.isRecording) recording.refSet.add(reactiveObj);
      return key in target ? target[key] : undefined;
    },
    set(target: T, key: string, value: any) {
      console.log("set:", key, value);
      target[key] = value;
      if (effectMap.has(reactiveObj))
        effectMap.get(reactiveObj)!.forEach((fn) => fn());
      return value;
    },
  });
  return reactiveObj;
}

function watch(dep: Dependency | Dependency[], fn: () => void) {
  const depArr = dep instanceof Array ? dep : [dep];
  depArr.forEach((d) => {
    if (!effectMap.has(d)) effectMap.set(d, new Set());
    effectMap.get(d)!.add(fn);
  });
}

function watchEffect(fn: () => void) {
  recording.isRecording = true;
  fn();
  recording.isRecording = false;
  recording.refSet.forEach((ref) => {
    if (!effectMap.has(ref)) effectMap.set(ref, new Set());
    effectMap.get(ref)!.add(fn);
  });
  recording.refSet.clear();
}

function computed<T>(fn: () => T) {
  const refObj = ref(<T>null);
  watchEffect(() => (refObj.value = fn()));
  return refObj;
}
```

:::

ä½ å¯ä»¥è‡ªå·±è¯•ç€ç©ä¸€ç©ï¼š

```ts
const a = ref(1);
watchEffect(() => {
  console.log("eff:", a.value);
});
// get: 1
// eff: 1
a.value = 5;
// set: 5
// get: 5
// eff: 5
a.value += 3;
// get: 5
// set: 8
// get: 8
// eff: 8
```

## å“åº”å¼çš„å¸¸è§é—®é¢˜

### `watchEffect` ä¸å¼‚æ­¥

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšåœ¨ `watchEffect` ä¸­å¯¹å‡½æ•°çš„ç›‘å¬æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰å‡½æ•°çš„åŒæ­¥éƒ¨åˆ†ä»£ç ï¼ˆåŒæ­¥å‡½æ•°ã€`async` å‡½æ•°ä¸­ç¬¬ä¸€ä¸ª `await` ä¹‹å‰çš„éƒ¨åˆ†ï¼‰æ‰ä¼šè¢«ç›‘æ§ã€‚å› æ­¤ï¼Œå¦‚æœæ˜¯è¿™æ ·ä¸€æ®µä»£ç ï¼š

```ts
const a = ref(0);
watchEffect(async () => {
  await Promise.resolve();
  console.log("effect:", a.value);
});
setTimeout(() => {
  a.value = 1;
}, 1000);

// get: 0
// effect: 0
// [1s è¿‡å]
// set: 1
```

`watchEffect` ä¸­çš„å‡½æ•°åªæœ‰ç¬¬ä¸€æ¬¡è¿è¡Œäº†ï¼Œåç»­ `a.value` çš„ä¿®æ”¹æ²¡æœ‰è§¦å‘å†æ¬¡æ‰§è¡Œã€‚è¿™è¯´æ˜æ­¤ä¾‹ä¸­ `watchEffect` æ²¡æœ‰æˆåŠŸç›‘å¬åˆ° `a`ã€‚

## å‚è€ƒèµ„æ–™

- [Vue.js æ–‡æ¡£ï¼šæ·±å…¥å“åº”å¼ç³»ç»Ÿ](https://cn.vuejs.org/guide/extras/reactivity-in-depth.html)
